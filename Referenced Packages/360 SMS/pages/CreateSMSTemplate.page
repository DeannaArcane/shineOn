<apex:page doctype="html-5.0" standardController="tdc_tsw__Message_Template__c" showHeader="true" standardStylesheets="true" sidebar="false" extensions="tdc_tsw.CreateSMSTemplateExtension" id="pageId">
<html xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<head>
    <apex:includeScript value="/soap/ajax/15.0/connection.js" />
    <apex:includeScript value="/soap/ajax/15.0/apex.js" />
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- <link rel="stylesheet" href="{!URLFOR($Resource.SLDS214, '/assets/styles/salesforce-lightning-design-system.min.css')}" /> -->
    <!-- <apex:stylesheet value="{!URLFOR($Resource.SLDS214, '/assets/styles/salesforce-lightning-design-system.min.css')}"/> -->
    <apex:slds />
    <link href = "https://rawgit.com/mervick/emojionearea/master/dist/emojionearea.min.css" rel = "stylesheet"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.17.0/moment.min.js"></script>
    <script src="{!URLFOR($Resource.aljs, 'jquery.aljs-all.min.js')}"></script>
    <script src = "https://rawgit.com/mervick/emojionearea/master/dist/emojionearea.js"></script>
    <apex:includeScript value="{!URLFOR($Resource.tdc_tsw__resource_sms_file, '/js/Console_IntegrationFile1.js')}"/>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/css/select2.min.css" type="text/css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/js/select2.min.js"></script> 
 
    
    
    <style type="text/css">
    .slds-scope .form-wrapper {
        padding: 1.5rem;
    }
    .slds-scope .slds-card__body {
        background: #fff;
    }

    .slds-scope .slds-section-title--divider {
        display: block;
    }

    .slds-scope .slds-card {
        max-width: 1200px;
        margin: 0 auto;
    }
    .slds-scope input.btn{
        padding-left: 1rem;
        padding-right: 1rem;
    }
    .slds-scope .emojionearea .emojionearea-editor:empty:before 
       {
        content: attr(placeholder);
        display: none;
        color: #bbb;
        }
    
    .slds-scope .slds-section-title--divider {
        background: #d8dde6;
    }
    
    .slds-scope .message {
        margin: 0 0 10px;
        max-width: 500px;
    }
    .slds-scope .slds-section-title--divider {
        background: #d8dde6;
    }
    
    .slds-scope .slds-card {
        background-color: #d8dde6;
    }
    
    .slds-scope .slds-textarea {
        min-height: 100px;
    }
    .slds-scope .Verify-btn{
        display:inline-block;
        margin-left:5px;
    }
    @media (max-width: 767px){
        .slds-scope .record-type{
            margin-right:0px !important;
            padding-top: 10px !important;
        }
        .slds-scope .Verify-btn{
            display:inline-block;
            margin-top: 10px;
        }
        .slds-scope .form-wrapper{
            padding: 0px
        }
        .slds-scope .field{
            padding-right: .5rem !important;
            padding-left: .5rem !important;
        }
        
    }
        .slds-scope .txtsearch{
            max-width: calc(100% - 0px);
        }
       .slds-scope .Go-btn{
            margin-left: 0.5em;
        }
        .slds-scope .record-name{
            width: calc(100% - 48px);
        }
        .slds-scope .slds-select{
            -webkit-appearance: none;
            padding: 0px 10px;
        }
    @media (max-width: 480px){
        .slds-scope .Go-btn .slds-button--brand{
            padding-left: 0.5rem;
            padding-right: 0.5rem;
        }
    }
    .slds-scope .infoM3 .msgIcon, .infoMedium{
        background-image: url(/img/msg_icons/info24.png);
        background-position: 0 0;
        width: 35px;
        height: 24px;
        background-repeat: no-repeat;
    }
    select{
        max-width: 262px;
    }
    
    .select2-container {
    	width:100% !important;
    }
    </style>
    <script>
    function abc(objId, objName) {
        document.getElementById('pageId:formId:RecordName').value = objName;
        apexmethod(objId);
        //$('.slds-backdrop').removeClass('slds-backdrop--open');
        //$('.slds-modal').removeClass('slds-fade-in-open');
        $('.recordIdSection').show();
        $('.lookupSection').hide();
    }

    $(".slds-modal__close").click(function() {
        $('.slds-backdrop').removeClass('slds-backdrop--open');
        $('.slds-modal').removeClass('slds-fade-in-open');
    });

    function openModal() {
    //alert('openModal');
        $('.recordIdSection').hide();
        $('.slds-backdrop').addClass('slds-backdrop--open');
        $('.slds-modal').addClass('slds-fade-in-open');
        $('.lookupSection').show();
    }
    </script>
    
    
</head>
<body>
    <div class="slds-scope">
    <apex:form id="formId" styleClass="form-wrapper">
    <c:DoNotDisplayPage />
        <script>  
        function CloseAndRefres(){
        
            var isMobile = false;
           if( /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
                isMobile = true;
            }
            //alert(isMobile);
            //alert('{!returnURL}');        
            isError = '{!isError}';
            if(isError == 'false'){
                if(isMobile == true)
                {
                    sforce.one.navigateToURL('#/sObject/tdc_tsw__Message_Template__c/home');
                }
                else
                {
                    //var url = (window.location != window.parent.location)  ? document.referrer  : document.location;
                    window.top.location.href="{!returnURL}";
                    //window.top.location.href = url;
                    window.opener.location.reload(true);
                }  
               
            }
        }
     </script>
     <script>
        /*function verify() {
            //var verify = document.getElementsByClassName('Verify_modal');
            //verify[0].style.display = 'block';

            var smsbody = document.getElementById('pageId:formId:pbID:templateText_1').value;
            var objectName = document.getElementById('pageId:formId:pbID:j_id36:0:objectSelectList1').value;
            var newwindow = window.open('/apex/VerifySmsBody?smsbody=' + smsbody + '&objectName=' + objectName, 'Call Report', scrollbars = 'no', toolbar = 'no', status = 'no');
            //$('.objList').val(objectName);
            //$('.msgBody').val(smsbody);
            newwindow.focus();
        }*/
        function CloseAndRefresh() {
            $('.slds-modal__content').scrollTop(200);
            //window.scrollBy(0, 200);
        }

        /*function jsfun1(value) {
            var currelmvalue = value;

            var isTrue = isGSMAlphabet(currelmvalue);
            var segment = 1;
            var nonGsmLength = currelmvalue.length;
            var strLength = currelmvalue.length + count(currelmvalue, '{') + count(currelmvalue, '}') + count(currelmvalue, '[') + count(currelmvalue, ']');
            if (isTrue) {
                if (strLength <= 160) {
                    segment = 1;
                } else {
                    if (strLength % 153 == 0)
                        segment = (strLength / 153);
                    else
                        segment = (strLength / 153) + 1;
                }
            } else {
                if (nonGsmLength <= 70) {
                    segment = 1;
                } else {
                    if (nonGsmLength % 67 == 0)
                        segment = (nonGsmLength / 67);
                    else
                        segment = (nonGsmLength / 67) + 1;
                }
            }
            if (currelmvalue.length == 0) {
                segment = 0;
            }

             document.getElementById('{!$Component.optextId}').style.color="black";
              if(currelmvalue.length == 1 )
                document.getElementById('{!$Component.optextId}').innerHTML='You Have Entered '+currelmvalue.length+' Character.     '+'Segment : '+parseInt(segment,10)+' (Segment will depend on merge fields)';
              else if(currelmvalue.length == 0)
                document.getElementById('{!$Component.optextId}').innerHTML= 'You Can Enter Up To 1000 Characters';
              else
                document.getElementById('{!$Component.optextId}').innerHTML='You Have Entered '+currelmvalue.length+' Characters.    '+'Segment : '+parseInt(segment,10)+' (Segment will depend on merge fields)';

        }*/

        /*function jsfun2(value) {
            var currelmvalue = value;

            var isTrue = isGSMAlphabet(currelmvalue);
            var segment = 1;
            var nonGsmLength = currelmvalue.length;
            var strLength = currelmvalue.length + count(currelmvalue, '{') + count(currelmvalue, '}') + count(currelmvalue, '[') + count(currelmvalue, ']');
            if (isTrue) {
                if (strLength <= 160) {
                    segment = 1;
                } else {
                    if (strLength % 153 == 0)
                        segment = (strLength / 153);
                    else
                        segment = (strLength / 153) + 1;
                }
            } else {
                if (nonGsmLength <= 70) {
                    segment = 1;
                } else {
                    if (nonGsmLength % 67 == 0)
                        segment = (nonGsmLength / 67);
                    else
                        segment = (nonGsmLength / 67) + 1;
                }
            }
            if (currelmvalue.length == 0) {
                segment = 0;
            }
            //console.log(currelmvalue.length);
             document.getElementById('{!$Component.optextId2}').style.color="black";
              if(currelmvalue.length == 1 )
                document.getElementById('{!$Component.optextId2}').innerHTML='You Have Entered '+currelmvalue.length+' Character.     '+'Segment : '+parseInt(segment,10)+' (Segment will depend on merge fields)';
              else if(currelmvalue.length == 0)
                document.getElementById('{!$Component.optextId2}').innerHTML= 'You Can Enter Up To 1000 Characters';
              else
                document.getElementById('{!$Component.optextId2}').innerHTML='You Have Entered '+currelmvalue.length+' Characters.    '+'Segment : '+parseInt(segment,10)+' (Segment will depend on merge fields)';

        }*/
        
        function isGSMAlphabet(text) {
            //alert(text);
            var regexp = new RegExp("^[A-Za-z0-9 @!\"#$%&'`()*+,_\\-./:;<=>?^{}\\\\\\[~\\]|\\r\\n]*$");
            //alert(regexp.test(text)) ;
            return regexp.test(text);

        }

        function count(text, c) {
            var result = 0,
                i = 0;
            for (i; i < text.length; i++) {
                if (text[i] == c)
                    result++;
            }
            //alert('=====result:'+result);
            return result;

        }

        /* $(document).ready(function() {
          emojiMethod();
          jsfun1($('.abc').val());
            
        });
        
        
       function emojiMethod(){
          $("textarea.abc").emojioneArea({
            events: {
              keyup: function (editor, event) {
                  var str = this.getText();
                  if(str.length > 0 && str[str.length - 1].charCodeAt(0) == 10) {
                    str = str.substring(0, str.length - 1);
                    jsfun1(str);  
                  } else {
                    jsfun1(str);
                  }
                  
              },
              emojibtn_click: function (button, event) {
                jsfun1(this.getText());
              } 
            }
          });
        }
        
        
        
        $(function() {
            $("body").on("keyup", ".slds-modal__content .abc2", function() {
                jsfun2($(this).val());
            })
            
        })*/
        
        function textCountUpdate(currelm){
        //console.log('textCountUpdate');
         var isTrue = isGSMAlphabet(currelm.value);
                //alert('====isTrue:'+ isTrue);
                var segment = 1;
                var nonGsmLength = currelm.value.length;
                var strLength = currelm.value.length + count(currelm.value,'{') + count(currelm.value,'}') + count(currelm.value,'[') + count(currelm.value,']');
                if(isTrue)
                {
                     if(strLength <= 160){
                       segment = 1;
                     }
                     else{
                          if(strLength % 153 == 0)
                              segment = (strLength/153);
                          else
                             segment = (strLength/153)+1;
                      }
                }
                else
                {
                   if(nonGsmLength <= 70){
                       segment = 1;
                     }
                     else{
                        if(nonGsmLength%67 == 0)
                            segment = (nonGsmLength/67);
                        else
                            segment = (nonGsmLength/67)+1;
                        }       
                }       
              if (currelm.value.length == 0) {
                segment = 0;
            }
            //console.log(currelm.value.length);
             document.getElementById('{!$Component.optextId}').style.color="black";
              if(currelm.value.length == 1 )
                document.getElementById('{!$Component.optextId}').innerHTML='You Have Entered '+currelm.value.length+' Character.     '+'Segment : '+parseInt(segment,10)+' (Segment will depend on merge fields)';
              else if(currelm.value.length == 0)
                document.getElementById('{!$Component.optextId}').innerHTML= 'You Can Enter Up To 1000 Characters';
              else
                document.getElementById('{!$Component.optextId}').innerHTML='You Have Entered '+currelm.value.length+' Characters.    '+'Segment : '+parseInt(segment,10)+' (Segment will depend on merge fields)';

        } 
        
        function textCountUpdate1(currelm){
        
        //console.log('textCountUpdate1', currelm);
         var isTrue = isGSMAlphabet(currelm.value);
                //alert('====isTrue:'+ isTrue);
                var segment = 1;
                var nonGsmLength = currelm.value.length;
                var strLength = currelm.value.length + count(currelm.value,'{') + count(currelm.value,'}') + count(currelm.value,'[') + count(currelm.value,']');
                if(isTrue)
                {
                     if(strLength <= 160){
                       segment = 1;
                     }
                     else{
                          if(strLength % 153 == 0)
                              segment = (strLength/153);
                          else
                             segment = (strLength/153)+1;
                      }
                }
                else
                {
                   if(nonGsmLength <= 70){
                       segment = 1;
                     }
                     else{
                        if(nonGsmLength%67 == 0)
                            segment = (nonGsmLength/67);
                        else
                            segment = (nonGsmLength/67)+1;
                        }       
                }       
               if (currelm.value.length == 0) {
                segment = 0;
            }
            console.log(currelm.value.length);
             document.getElementById('{!$Component.optextId2}').style.color="black";
              if(currelm.value.length == 1 )
                document.getElementById('{!$Component.optextId2}').innerHTML='You Have Entered '+currelm.value.length+' Character.     '+'Segment : '+parseInt(segment,10)+' (Segment will depend on merge fields)';
              else if(currelm.value.length == 0)
                document.getElementById('{!$Component.optextId2}').innerHTML= 'You Can Enter Up To 1000 Characters';
              else
                document.getElementById('{!$Component.optextId2}').innerHTML='You Have Entered '+currelm.value.length+' Characters.    '+'Segment : '+parseInt(segment,10)+' (Segment will depend on merge fields)';

        } 
        function ClosePopup()
        {
            //alert('ClosePopup');
            document.getElementById('{!$Component.formID.RecordName}').value = '';
            clear();
        }
        
        $(document).ready(function() {
        //alert('ready--'+document.getElementById('pageId:formId:templateText_1'));
            //textCountUpdate1(document.getElementById('pageId:formId:templateText_1'));
            textCountUpdate(document.getElementById('pageId:formId:templateText_1'));
            
        });
        
        function disableButton(buttonObj){
                //alert('disabled');
                buttonObj.disabled=true;
         }
        
        </script>
        <apex:actionFunction name="clear" action="{!clearValue}" reRender="formId"/>
        <div class="slds-card">
            <div class="slds-card__header slds-grid">
                <header class="slds-media slds-media--center slds-has-flexi-truncate">
                    <div class="slds-media__body">
                        <h2>
                            <span href="javascript:void(0);" class="slds-card__header-link slds-truncate">
                                <span class="slds-text-heading--small">SMS APP</span>
                            </span>
                            <p>Message Template</p>
                        </h2>
                    </div>
                </header>
            </div>
            <div class="slds-card__body slds-p-vertical--medium slds-p-horizontal--large field">
                <apex:actionFunction name="getFields" action="{!findRelatedField}" reRender="pbID" status="actStatusId">
                    <apex:param assignTo="{!currentIndex}" value="" name="selectedIndex" />
                    <apex:param assignTo="{!currentSelectfield}" value="" name="varfield"/>
                </apex:actionFunction>
                <apex:actionFunction name="onChangeObjectAF" action="{!onChangeObject}" reRender="pbID" status="actStatusId">
                	<apex:param name="varsObj" value="" assignTo="{!sObjectName}"/>
                </apex:actionFunction>
                <apex:outputpanel id="errorPanel">
                    <apex:pageMessages />
                </apex:outputpanel>
                <div class="slds-grid slds-wrap">
                    <div class="slds-size--1-of-1 slds-medium-size--1-of-4 slds-large-size--1-of-4 slds-small-size--1-of-1 slds-col--padded">
                        <div class="slds-form-element slds-m-bottom--large">
                            <label class="slds-form-element__label">Template Name</label>
                            <div class="slds-form-element__control">
                                <apex:inputtext value="{!templateName}" styleClass="slds-input" html-placeholder="" />
                            </div>
                        </div>
                    </div>
                    <div class="slds-size--1-of-1 slds-medium-size--1-of-4 slds-large-size--1-of-4 slds-small-size--1-of-1 slds-col--padded">
                        <div class="slds-form-element slds-m-bottom--large">
                            <label class="slds-form-element__label">Select Object</label>
                            <div class="slds-form-element__control">
                                <!-- <apex:selectList value="{!sObjectName}" size="1" styleClass="slds-select" id="objectSelectList1" onchange="onChangeObjectAF();" rendered="{!$ObjectType.tdc_tsw__Message_Template__c.fields.tdc_tsw__ObjectName__c.Updateable}">
                                    <apex:selectOptions value="{!ObjectsList}" />
                                </apex:selectList> -->
                                <select id="select_id" name="sobjectname" class="js-example-basic-single js-states form-control search-picklist">
                                                            
                                </select>
                                    
                            </div>
                        </div>
                    </div>
                    <div class="slds-size--1-of-1 slds-medium-size--1-of-4 slds-large-size--1-of-4 slds-small-size--1-of-1 slds-col--padded">
                    </div>
                    <div class="slds-size--1-of-1 slds-medium-size--1-of-4 slds-large-size--1-of-4 slds-small-size--1-of-1 slds-col--padded">
                    </div>
                </div>
                <h3 class="slds-section-title--divider slds-m-bottom--medium">Generate Formula</h3>
                <apex:outputPanel id="pbID">
                    <div class="slds-wrap slds-grid slds-m-bottom--large slds-col--padded">
                        <div class="slds-size--1-of-1 slds-medium-size--1-of-4 slds-large-size--1-of-4 slds-small-size--1-of-1 record-type" style="padding-right: 15px">
                            <div class="slds-form-element__control">
                            	<select id="select_id1" name="sobjectname" class="js-example-basic-single js-states form-control search-picklist1">
                                                        
                            	</select>
                            </div>
                        </div>
                        <apex:repeat value="{!lstFieldWrapper}" var="wrap">
                            <apex:outputPanel rendered="{!wrap.Index != 0}">
                            <div class="slds-size--1-of-1 slds-medium-size--1-of-4 slds-large-size--1-of-4 slds-small-size--1-of-1 record-type" style="width: 100%;padding-right: 15px;">
                                <div class="slds-form-element__control">
                                	<!-- <apex:outputPanel rendered="{!wrap.Index == 0}">
	                                    <select id="select_id1" name="sobjectname" class="js-example-basic-single js-states form-control search-picklist1">
                                                            
                                		</select>
                                    </apex:outputPanel> -->
                                	
	                                    <apex:selectList value="{!wrap.selectedField}" size="10" styleClass="slds-select" id="objectSelectList1" onchange="getFields('{!wrap.index}')" rendered="{!$ObjectType.tdc_tsw__Message_Template__c.fields.tdc_tsw__ObjectName__c.Updateable}">
	                                        <apex:selectOptions value="{!wrap.lstField}" />
	                                    </apex:selectList>
                                </div>
                            </div>
                            </apex:outputPanel>
                        </apex:repeat>
                    </div>
                    
                    <div class="slds-grid slds-wrap">
                        <div class="slds-size--1-of-1 slds-medium-size--1-of-4 slds-large-size--1-of-4 slds-small-size--1-of-1 slds-m-bottom--medium slds-col--padded">
                            <apex:outputPanel rendered="{!isFinalResult}">
                                <label class="slds-form-element__label">Formula Value</label>
                                <div class="slds-form-element__control">
                                    <apex:inputtext id="templateText2" value="{!formula}" styleclass="slds-input" />
                                </div>
                            </apex:outputPanel>
                        </div>
                    </div>
                    
                    <h3 class="slds-section-title--divider slds-m-bottom--medium">Template Body</h3>
                    <div>
                        <div class="slds-grid slds-wrap slds-m-bottom--large">
                            <div class="slds-size--1-of-1 slds-col--padded">
                                <div class="slds-form-element">
                                    <div class="slds-form-element__control">
                                        <apex:outputPanel rendered="{!!bodyError}">
                                            <apex:inputTextarea value="{!smsbody}" label="Message" onkeyup="textCountUpdate(this);" title="Message" cols="35" rows="5" id="templateText_1" styleClass="abc templateText slds-textarea" style="border-color: #ccc" html-maxlength="1000" rendered="{!$ObjectType.tdc_tsw__Message_Template__c.fields.tdc_tsw__SMSBodyNew__c.Updateable}" />
                                        </apex:outputPanel>
                                    </div>
                                </div>
                            </div>
                            <div class="slds-size--1-of-1 slds-col--padded">
                                <div class="slds-form-element">
                                    <div class="slds-form-element__control">
                                        <apex:outputPanel rendered="{!bodyError}">
                                            <apex:inputTextarea value="{!smsbody}" label="Message" onkeyup="textCountUpdate(this);" title="Message" rows="5" id="templateText" styleClass="abc templateText slds-textarea" style="border-color: #800000" html-maxlength="1000" rendered="{!$ObjectType.tdc_tsw__Message_Template__c.fields.tdc_tsw__SMSBodyNew__c.Updateable}" />
                                        </apex:outputPanel>
                                    </div>
                                </div>
                            </div>
                            <apex:outputText value="You Can Enter Up To 1000 Characters" id="optextId" rendered="true" styleClass="slds-col--padded"></apex:outputText>
                        </div>
                                
                                    

                        <div class="slds-grid slds-wrap">
                            <apex:outputPanel rendered="{!IF(AND(showRecordType,lstRecordType.size > 0) ,true , false)}" styleclass="slds-size--1-of-1 slds-medium-size--1-of-4 slds-large-size--1-of-4 slds-small-size--1-of-1 slds-col--padded" layout="block">
                                    <apex:outputPanel styleclass="slds-form-element slds-m-bottom--large record-type"  layout="block">
                                        <label class="slds-form-element__label">Record Type</label>
                                        <div class="slds-form-element__control">
                                            <apex:selectList value="{!recTypeList}" size="3" multiselect="true" styleClass="slds-select">
                                                <apex:selectOptions value="{!RecordType}" />
                                            </apex:selectList>
                                        </div>
                                    </apex:outputPanel>
                             </apex:outputPanel>
                            <div class="slds-size--1-of-1 slds-medium-size--1-of-4 slds-large-size--1-of-4 slds-small-size--1-of-1 slds-col--padded">
                                <apex:outputPanel rendered="{!IF(AND(lstFolder.size > 0 ,enableFolder.tdc_tsw__AutoForwardToMobile__c),true,false)}" styleclass="slds-form-element slds-m-bottom--large record-type" layout="block">
                                    <label class="slds-form-element__label">Folder</label>
                                    <div class="slds-form-element__control">
                                        <apex:selectList value="{!folderName}" size="1"  styleClass="slds-select">
                                            <apex:selectOptions value="{!Folder}" />
                                        </apex:selectList>
                                    </div>
                                </apex:outputPanel>
                            </div>
                            <div class="slds-size--1-of-1 slds-medium-size--1-of-4 slds-large-size--1-of-4 slds-small-size--1-of-1 slds-col--padded">
                            </div>
                            <div class="slds-size--1-of-1 slds-medium-size--1-of-4 slds-large-size--1-of-4 slds-small-size--1-of-1 slds-col--padded">
                            </div>
                        </div>

                    </div>
                    <div class="slds-m-top--large slds-text-align--center ">
                        <apex:commandLink styleClass="slds-button slds-button--brand" action="{!save}">Save</apex:commandLink>
                        <apex:commandLink styleClass="slds-button slds-button--brand" action="{!varCancel}" onComplete="CloseAndRefres();" reRender="formId">Cancel</apex:commandLink>
                        <apex:outputPanel rendered="{!showPopup}" styleClass="Verify-btn" style="">
                             <apex:commandLink styleClass="slds-button slds-button--brand searchModal-btn" reRender="searchSec" action="{!search1}" >Send Test and Verify merge field</apex:commandLink>
                        </apex:outputPanel>                    
                    </div>

                    <apex:outputPanel id="searchSec1" rendered="true" >
                            <div role="dialog" tabindex="-1" aria-labelledby="header43" class="slds-modal searchModal">
                                <div class="slds-modal__container">
                                    <div class="slds-modal__header">
                                        <button class="slds-button slds-modal__close slds-button--icon-inverse" title="Close" type="button" onClick="ClosePopup()">
                                            <apex:image url="{!URLFOR($Resource.tdc_tsw__SLDS214, '/assets/icons/action/close_60.png')}" />
                                            <span class="slds-assistive-text">Close</span>
                                        </button>
                                        <h2 id="header43" class="slds-text-heading--medium">Preview SMS Template with the following records</h2>
                                    </div>
                                    <div class="slds-modal__content slds-p-around--medium">
                                        <apex:outputPanel id="modalSec">
                                           
                                            <apex:outputpanel id="searchSec" styleClass="recordIdSection">
                                                
                                                    <apex:actionFunction name="apexmethod" action="{!showValue}" reRender="page2,k,selvalue" oncomplete="textCountUpdate1(document.getElementById('{!$Component.formID.selvalue}'));">
                                                        <apex:param name="firstParam" assignTo="{!recordId}" value="" />
                                                    </apex:actionFunction>
                                                   <!--  <div class="slds-grid slds-wrap slds-p-bottom--xx-small">
                                                        <div class="slds-form-element slds-col">
                                                            <label class="slds-form-element__label">Object Name</label>
                                                            <div class="slds-form-element__control">
                                                                <apex:selectList size="1" value="{!sObjectName}" styleClass="slds-select inputMaxLen objList">
                                                                    <apex:selectOptions value="{!statusOptions}" />
                                                                </apex:selectList>
                                                            </div>
                                                        </div>
                                                    </div>
                                                     -->
                                                     
                                                    <div class="slds-grid slds-wrap slds-p-bottom--xx-small">
                                                        <div class="slds-form-element slds-m-right--small record-name">
                                                            <label class="slds-form-element__label">Record Name</label>
                                                            <div class="slds-form-element__control">
                                                                <apex:inputText id="RecordName" styleClass="slds-input inputMaxLen recordBlank" />
                                                            </div>
                                                        </div>
                                                        <div class="slds-form-element slds-m-top--large search_box">
                                                            <apex:commandLink action="{!Search}" value="" styleClass="slds-button slds-button--icon-border" onComplete="openModal()" reRender="page2,showSendSmsid">
                                                                <apex:image value="{!$Resource.tdc_tsw__search_01}" />
                                                            </apex:commandLink>
                                                        </div>
                                                        
                                                    </div>
                                                    <apex:outputPanel id="msgbody">
                                                    <div class="slds-grid slds-wrap slds-p-bottom--xx-small">
                                                        <div class="slds-form-element slds-col">
                                                            <label class="slds-form-element__label">
                                                                <apex:outputLabel value="Message Body" />
                                                            </label>
                                                            <div class="slds-form-element__control slds-p-top--medium">
                                                                <apex:inputTextarea value="{!selectValue}" id="selvalue" onkeyup="textCountUpdate1(this);" styleClass="slds-textarea sldsHeight msgBody abc2" />
                                                            
                                                            </div>
                                                            <apex:outputText value="You Can Enter Up To 1000 Characters" id="optextId2" rendered="true" ></apex:outputText>
                                                        </div>
                                                       <script>
                                                           
                                                            var ele = document.getElementById('{!$Component.formID.selvalue}');
                                                            textCountUpdate1(ele);
                                                        </script>
                                                        
                                                    </div>
                                                    </apex:outputPanel>
                                                    
                                                    <apex:outputpanel id="showSendSmsid">
                                                   
                                                        <apex:outputPanel rendered="{!showSendSmsButton}" >
                                                             <div class="slds-grid slds-wrap slds-p-bottom--xx-small">
                                                                <div class="slds-form-element slds-col">
                                                                    <label class="slds-form-element__label">Enter Phone Number</label>
                                                                    <div class="slds-form-element__control">
                                                                        <apex:inputText id="phoneNumber" value="{!phoneNumber}" styleClass="slds-input inputMaxLen recordBlank" />
                                                                    </div>
                                                                </div>
                                                            </div>  
                                                            <div class="slds-m-top--large slds-text-align--center">
                                                              <apex:commandLink styleClass="slds-button slds-button--brand" action="{!sendSms}" rerender="showSendSmsid" onComplete="CloseAndRefresh()" onclick="disableButton(this)">Send SMS</apex:commandLink>
                                                            </div>
                                                            <br/>
                                                             <apex:outputPanel id="ErrorMessage"  rendered="{!isError}" style="color:red;">
                                                                  <apex:pageMessages escape="false" />
                                                             </apex:outputPanel>
                                                         </apex:outputPanel>
                                                   </apex:outputpanel>
                                                 
                                            </apex:outputpanel>
    
                                            <!-- second modal content -->
                                            <apex:outputPanel id="page2" styleClass="lookupSection"  style="display:none ">
                                                <apex:outputPanel id="page1" rendered="{!showLook}">
                                                    <div class="showfield">
                                                    <apex:outputPanel id="top">
                                                        <div class="slds-grid slds-m-bottom--large">
                                                            <label class="slds-form-element__label">Search</label>
                                                            <div class="slds-form-element__control">
                                                                <apex:inputText id="txtSearch" value="{!searchString}" styleClass="slds-input txtsearch" />
                                                            </div>
                                                            <div class="slds-form-element slds-m-left--xx-large Go-btn">
                                                                <apex:commandLink id="btnGo" value="Go" action="{!Search}" styleClass="slds-button slds-button--brand" rerender="searchResults" />
                                                            </div>
                                                        </div>
                                                    </apex:outputPanel>                                                   
                                                    <apex:outputPanel id="searchResults">
                                                        <table class="slds-table slds-table--bordered">
                                                            <thead>
                                                                <tr>
                                                                    <th>Name </th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                <apex:repeat value="{!results}" var="a" id="tblResults">
                                                                    <tr>
                                                                        <td>
                                                                            <apex:outputLink onclick="abc('{!a['Id']}','{!a['Name']}');return false;" value="javascript:top.window.opener.lookupPick2('{!a['Id']}','{!a['Name']}', false)" rendered="{!AND(NOT(ISNULL(a.Id)),isObject)}">{!a['name']}</apex:outputLink> 
                                                                            <apex:outputLink onclick="abc('{!a['Id']}','{!a['caseNumber']}');return false;" value="javascript:top.window.opener.lookupPick2('{!a['Id']}','{!a['caseNumber']}', false)" rendered="{!AND(NOT(ISNULL(a.Id)),isCase)}">{!a['caseNumber']}</apex:outputLink>       
                                                                            <apex:outputLink onclick="abc('{!a['Id']}','{!a['subject']}');return false;" value="javascript:top.window.opener.lookupPick2('{!a['Id']}','{!a['subject']}', false)" rendered="{!AND(NOT(ISNULL(a.Id)),isTask)}">{!a['subject']}</apex:outputLink>                                                                      
                                                                            <apex:outputLink onclick="abc('{!a['Id']}','{!a['Id']}');return false;" value="javascript:top.window.opener.lookupPick2('{!a['Id']}','{!a['Id']}', false)" rendered="{!AND(NOT(ISNULL(a.Id)),isCampaignMember)}">{!a['Id']}</apex:outputLink>
                                                                        </td>                   
                                                                    </tr>
                                                                </apex:repeat>
                                                            </tbody>
                                                        </table>
                                                    </apex:outputPanel>
                                                    </div>
                                                </apex:outputPanel>
                                            </apex:outputPanel>
                                        </apex:outputPanel>
                                    </div>
                                    <div class="slds-modal__footer">
                                        <button class="slds-button slds-button--neutral slds-modal__close">Cancel</button>
                                        <script type="text/javascript">
                                            $('.searchModal-btn').on('click', function() {
                                                //loading image
                                                setTimeout(function(){
                                                    $('.searchModal').addClass('slds-fade-in-open');
                                                    $('.slds-backdrop').addClass('slds-backdrop--open');
                                                    $('.showfield').hide();
                                                }, 1000);
                                                
                                            })
                                            $('.slds-button--icon-inverse').click(function(){
                                            setTimeout(function(){}, 2000);
                                                $('.searchModal').removeClass('slds-fade-in-open');
                                                $('.slds-backdrop').removeClass('slds-backdrop--open');
                                                $('.recordBlank').val('');
                                                return true;
                                            })
                                        </script>
                                    </div>
                                </div>
                            </div>    
                            <div class="slds-backdrop"></div>
                    </apex:outputPanel>
                    <script>
                    	var data1 = {!objString};
	                   console.log(data1);
	                   var options = '';
	                   $.each(data1, function(index, ele) {
	                       options += '<option value="'+ele['objName']+'" >'+ele["objLabel"]+'</option>';
	                   });
	                   
	                   //alert(options);
	                   var id1 = '{!currentSelectfield}';
	                   $(".search-picklist1").select2(); 
	                   $(".search-picklist1").html(options);
	                    
	                   $(".search-picklist1").val(id1);
	                   
	                   
	                   $(".search-picklist1").change(function(){
	                   		//alert($(".search-picklist1").val());
	                  		getFields(0,$(".search-picklist1").val());
	                   })
	                   /*var list = $(".search-picklist1").select2({
						  	closeOnSelect: false
						  }).on("select2:closing", function(e) {
						  	e.preventDefault();
						  }).on("select2:closed", function(e) {
						  	list.select2("open");
						  });
						list.select2("open");*/
                    </script>
                </apex:outputPanel>
                
                
            </div>            
        </div>
        <script type="text/javascript">  
                    
                   var data = {!objJsonString};
                   console.log(data);
                   var options = '';
                   $.each(data, function(index, ele) {
                       options += '<option value="'+ele['objName']+'" >'+ele["objLabel"]+'</option>';
                   });
                   
                   //alert(options);
                   var id = '{!sObjectName}';
                   $(".search-picklist").select2(); 
                   $(".search-picklist").html(options);
                    
                   $(".search-picklist").val(id);
                   
                   
                   $(".search-picklist").change(function(){
                  		onChangeObjectAF($(".search-picklist").val());
                   })
                                    
                   /*****************************************/
                   
                   
                  
                  
                  
                  
               </script>
    </apex:form>
   </div>
</body>
</html>
</apex:page>